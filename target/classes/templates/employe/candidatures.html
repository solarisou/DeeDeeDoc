<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liste des candidatures</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/app.css" rel="stylesheet">
    <style>
        .column-selector {
            background: var(--color-gray-light);
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .column-checkbox {
            margin-bottom: 10px;
        }
        .column-checkbox label {
            cursor: pointer;
            user-select: none;
            font-size: 0.9rem;
            margin-left: 5px;
        }
        .column-checkbox input[type="checkbox"] {
            cursor: pointer;
        }
        .table-responsive {
            overflow-x: auto;
        }
        .table th, .table td {
            white-space: nowrap;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Gestion Candidatures</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/candidat/deposer">Déposer une candidature</a>
                <a class="nav-link active" href="/employe/dashboard">Espace employé</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Liste des candidatures</h2>
            <div>
                <button type="button" class="btn btn-primary me-2" onclick="showTransfertModal()" id="btnTransfertMultiple" disabled>
                    Transférer les candidatures sélectionnées (<span id="countSelected">0</span>)
                </button>
                <a href="/employe/dashboard" class="btn btn-secondary">Retour au dashboard</a>
            </div>
        </div>
        
        <!-- Sélecteur de colonnes -->
        <div class="column-selector">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0">Sélectionner les colonnes à afficher</h6>
                <div>
                    <button class="btn btn-sm btn-success me-1" onclick="selectAllColumns()">Tout</button>
                    <button class="btn btn-sm btn-warning me-1" onclick="deselectAllColumns()">Rien</button>
                    <button class="btn btn-sm btn-info" onclick="resetColumns()">Défaut</button>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-3 column-checkbox">
                    <input type="checkbox" id="col-id" data-column="0" checked>
                    <label for="col-id">ID Candidature</label>
                </div>
                <div class="col-md-3 column-checkbox">
                    <input type="checkbox" id="col-nom" data-column="1" checked>
                    <label for="col-nom">Nom complet</label>
                </div>
                <div class="col-md-3 column-checkbox">
                    <input type="checkbox" id="col-email" data-column="2" checked>
                    <label for="col-email">Email</label>
                </div>
                <div class="col-md-3 column-checkbox">
                    <input type="checkbox" id="col-telephone" data-column="3" checked>
                    <label for="col-telephone">Téléphone</label>
                </div>
                <div class="col-md-3 column-checkbox">
                    <input type="checkbox" id="col-poste" data-column="4" checked>
                    <label for="col-poste">Type &amp; poste</label>
                </div>
                <div class="col-md-3 column-checkbox">
                    <input type="checkbox" id="col-date-candidature" data-column="5" checked>
                    <label for="col-date-candidature">Date candidature</label>
                </div>
                <div class="col-md-3 column-checkbox">
                    <input type="checkbox" id="col-date-dispo" data-column="6">
                    <label for="col-date-dispo">Date disponibilité</label>
                </div>
                <div class="col-md-3 column-checkbox">
                    <input type="checkbox" id="col-statut" data-column="7" checked>
                    <label for="col-statut">Statut</label>
                </div>
                <div class="col-md-3 column-checkbox">
                    <input type="checkbox" id="col-auth-stocker" data-column="8">
                    <label for="col-auth-stocker">Autorisation stockage</label>
                </div>
                <div class="col-md-3 column-checkbox">
                    <input type="checkbox" id="col-auth-diffuser" data-column="9">
                    <label for="col-auth-diffuser">Autorisation diffusion</label>
                </div>
                <div class="col-md-3 column-checkbox">
                    <input type="checkbox" id="col-date-expiration" data-column="10">
                    <label for="col-date-expiration">Date expiration RGPD</label>
                </div>
                <div class="col-md-3 column-checkbox">
                    <input type="checkbox" id="col-nb-diplomes" data-column="11">
                    <label for="col-nb-diplomes">Nombre de diplômes</label>
                </div>
                <div class="col-md-3 column-checkbox">
                    <input type="checkbox" id="col-diplomes" data-column="12">
                    <label for="col-diplomes">Liste des diplômes</label>
                </div>
                <div class="col-md-3 column-checkbox">
                    <input type="checkbox" id="col-nb-experiences" data-column="13">
                    <label for="col-nb-experiences">Nombre d'expériences</label>
                </div>
                <div class="col-md-3 column-checkbox">
                    <input type="checkbox" id="col-experiences" data-column="14">
                    <label for="col-experiences">Liste des expériences</label>
                </div>
                <div class="col-md-3 column-checkbox">
                    <input type="checkbox" id="col-nb-langues" data-column="15">
                    <label for="col-nb-langues">Nombre de langues</label>
                </div>
                <div class="col-md-3 column-checkbox">
                    <input type="checkbox" id="col-langues" data-column="16" checked>
                    <label for="col-langues">Liste des langues</label>
                </div>
                <div class="col-md-3 column-checkbox">
                    <input type="checkbox" id="col-nb-competences" data-column="17">
                    <label for="col-nb-competences">Nombre de compétences</label>
                </div>
                <div class="col-md-3 column-checkbox">
                    <input type="checkbox" id="col-competences" data-column="18">
                    <label for="col-competences">Principales compétences</label>
                </div>
                <div class="col-md-3 column-checkbox">
                    <input type="checkbox" id="col-nb-softskills" data-column="19">
                    <label for="col-nb-softskills">Nombre de soft skills</label>
                </div>
                <div class="col-md-3 column-checkbox">
                    <input type="checkbox" id="col-softskills" data-column="20">
                    <label for="col-softskills">Soft skills principales</label>
                </div>
                <div class="col-md-3 column-checkbox">
                    <input type="checkbox" id="col-permis" data-column="21">
                    <label for="col-permis">Permis de conduire</label>
                </div>
                <div class="col-md-3 column-checkbox">
                    <input type="checkbox" id="col-nb-fichiers" data-column="22">
                    <label for="col-nb-fichiers">Nombre de fichiers</label>
                </div>
                <div class="col-md-3 column-checkbox">
                    <input type="checkbox" id="col-created" data-column="23">
                    <label for="col-created">Date création</label>
                </div>
                <div class="col-md-3 column-checkbox">
                    <input type="checkbox" id="col-actions" data-column="24" checked>
                    <label for="col-actions">Actions</label>
                </div>
            </div>
        </div>
        
        <!-- Filtres -->
        <div class="row mb-4">
            <div class="col-md-6">
                <form method="get" class="d-flex">
                    <input type="text" name="recherche" class="form-control me-2" 
                           placeholder="Rechercher par nom ou prénom" 
                           th:value="${rechercheActuelle}">
                    <button type="submit" class="btn btn-outline-primary">Rechercher</button>
                </form>
            </div>
            
            <div class="col-md-6">
                <form method="get">
                    <select name="statut" class="form-select" onchange="this.form.submit()">
                        <option value="">Tous les statuts</option>
                        <option value="en_attente" th:selected="${statutSelectionne == 'en_attente'}">En attente</option>
                        <option value="accepte" th:selected="${statutSelectionne == 'accepte'}">Accepté</option>
                        <option value="refuse" th:selected="${statutSelectionne == 'refuse'}">Refusé</option>
                    </select>
                </form>
            </div>
        </div>
        
        <!-- Liste des candidatures -->
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="candidaturesTable">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 50px;">
                            <input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)">
                        </th>
                        <th data-column="0">ID</th>
                        <th data-column="1">Nom complet</th>
                        <th data-column="2">Email</th>
                        <th data-column="3">Téléphone</th>
                        <th data-column="4">Type &amp; poste</th>
                        <th data-column="5">Date candidature</th>
                        <th data-column="6">Date disponibilité</th>
                        <th data-column="7">Statut</th>
                        <th data-column="8">Auth. stockage</th>
                        <th data-column="9">Auth. diffusion</th>
                        <th data-column="10">Expiration RGPD</th>
                        <th data-column="11">Nb diplômes</th>
                        <th data-column="12">Diplômes</th>
                        <th data-column="13">Nb expériences</th>
                        <th data-column="14">Expériences</th>
                        <th data-column="15">Nb langues</th>
                        <th data-column="16">Langues</th>
                        <th data-column="17">Nb compétences</th>
                        <th data-column="18">Compétences</th>
                        <th data-column="19">Nb soft skills</th>
                        <th data-column="20">Soft skills</th>
                        <th data-column="21">Permis</th>
                        <th data-column="22">Nb fichiers</th>
                        <th data-column="23">Date création</th>
                        <th data-column="24">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="candidatEnrichi : ${candidatsEnrichis}">
                        <td>
                            <input type="checkbox" class="candidat-checkbox" 
                                   th:value="${candidatEnrichi.candidat.idCandidature}"
                                   th:data-autorise="${candidatEnrichi.candidat.autorisationDiffuser.name()}"
                                   onchange="updateSelectionCount()">
                        </td>
                        <td data-column="0" th:text="${candidatEnrichi.candidat.idCandidature}"></td>
                        <td data-column="1" th:text="${candidatEnrichi.candidat.nomComplet}"></td>
                        <td data-column="2" th:text="${candidatEnrichi.candidat.email}"></td>
                        <td data-column="3" th:text="${candidatEnrichi.candidat.telephone}"></td>
                        <td data-column="4">
                            <div>
                                <span class="badge"
                                      th:classappend="${candidatEnrichi.candidatureSpontanee} ? 'bg-secondary' : 'bg-primary'">
                                    <span th:text="${candidatEnrichi.typeCandidatureLibelle}"></span>
                                </span>
                            </div>
                            <div th:text="${candidatEnrichi.intitulePoste}"></div>
                        </td>
                        <td data-column="5" th:text="${candidatEnrichi.candidat.dateCandidature != null ? #temporals.format(candidatEnrichi.candidat.dateCandidature, 'dd/MM/yyyy') : '-'}"></td>
                        <td data-column="6" th:text="${candidatEnrichi.candidat.dateDisponibilite != null ? #temporals.format(candidatEnrichi.candidat.dateDisponibilite, 'dd/MM/yyyy') : '-'}"></td>
                        <td data-column="7">
                            <span class="badge" 
                                  th:classappend="${candidatEnrichi.candidat.statutCandidature.name() == 'en_attente'} ? 'bg-warning' : 
                                                 (${candidatEnrichi.candidat.statutCandidature.name() == 'accepte'} ? 'bg-success' : 
                                                 (${candidatEnrichi.candidat.statutCandidature.name() == 'refuse'} ? 'bg-danger' : 'bg-secondary'))"
                                  th:text="${candidatEnrichi.candidat.statutCandidature}"></span>
                        </td>
                        <td data-column="8">
                            <span class="badge" 
                                  th:classappend="${candidatEnrichi.candidat.autorisationStocker.name() == 'O'} ? 'bg-success' : 'bg-danger'"
                                  th:text="${candidatEnrichi.candidat.autorisationStocker.name() == 'O'} ? 'Oui' : 'Non'"></span>
                        </td>
                        <td data-column="9">
                            <span class="badge" 
                                  th:classappend="${candidatEnrichi.candidat.autorisationDiffuser.name() == 'O'} ? 'bg-success' : 'bg-danger'"
                                  th:text="${candidatEnrichi.candidat.autorisationDiffuser.name() == 'O'} ? 'Oui' : 'Non'"></span>
                        </td>
                        <td data-column="10" th:text="${candidatEnrichi.candidat.dateExpirationAutorisation != null ? #temporals.format(candidatEnrichi.candidat.dateExpirationAutorisation, 'dd/MM/yyyy') : '-'}"></td>
                        <td data-column="11"><span class="badge bg-secondary" th:text="${candidatEnrichi.nbDiplomes}"></span></td>
                        <td data-column="12" th:text="${candidatEnrichi.diplomesResume}"></td>
                        <td data-column="13"><span class="badge bg-secondary" th:text="${candidatEnrichi.nbExperiences}"></span></td>
                        <td data-column="14" th:text="${candidatEnrichi.experiencesResume}"></td>
                        <td data-column="15"><span class="badge bg-secondary" th:text="${candidatEnrichi.nbLangues}"></span></td>
                        <td data-column="16" th:text="${candidatEnrichi.languesResume}"></td>
                        <td data-column="17"><span class="badge bg-secondary" th:text="${candidatEnrichi.nbCompetences}"></span></td>
                        <td data-column="18" th:text="${candidatEnrichi.competencesResume}"></td>
                        <td data-column="19"><span class="badge bg-secondary" th:text="${candidatEnrichi.nbSoftSkills}"></span></td>
                        <td data-column="20" th:text="${candidatEnrichi.softSkillsResume}"></td>
                        <td data-column="21" th:text="${candidatEnrichi.permisResume}"></td>
                        <td data-column="22"><span class="badge bg-secondary" th:text="${candidatEnrichi.nbFichiers}"></span></td>
                        <td data-column="23" th:text="${candidatEnrichi.candidat.createdAt != null ? #temporals.format(candidatEnrichi.candidat.createdAt, 'dd/MM/yyyy HH:mm') : '-'}"></td>
                        <td data-column="24">
                            <a th:href="@{/employe/candidature/{id}(id=${candidatEnrichi.candidat.idCandidature})}" 
                               class="btn btn-sm btn-primary">Détail</a>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div th:if="${#lists.isEmpty(candidatsEnrichis)}" class="text-center mt-5">
            <p class="text-muted">Aucune candidature trouvée.</p>
        </div>
    </div>
    
    <!-- Modal de transfert multiple -->
    <div class="modal fade" id="transfertModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Transfert multiple de candidatures</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="formTransfertMultiple" method="post" action="/employe/candidatures/transferer-multiple">
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <strong><span id="nbCandidatsSelectionnes">0</span> candidature(s) sélectionnée(s)</strong>
                        </div>
                        
                        <div id="alertNonAutorises" class="alert alert-warning" style="display: none;">
                            <strong>Attention :</strong> <span id="nbNonAutorises">0</span> candidat(s) n'ont pas autorisé la diffusion et seront exclus du transfert.
                        </div>
                        
                        <div class="mb-3">
                            <label for="entrepriseDestinationMultiple" class="form-label">Entreprise destination:</label>
                            <select name="entrepriseDestination" id="entrepriseDestinationMultiple" class="form-select" required>
                                <option value="">-- Sélectionner une entreprise --</option>
                                <option th:each="entreprise : ${entreprises}" 
                                        th:value="${entreprise.idEntreprise}"
                                        th:text="${entreprise.nomEntreprise + ' (' + entreprise.emailEntreprise + ')'}">
                                </option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="commentaireMultiple" class="form-label">Commentaire (optionnel):</label>
                            <textarea name="commentaire" id="commentaireMultiple" class="form-control" rows="3"
                                      placeholder="Message accompagnant le transfert..."></textarea>
                        </div>
                        
                        <input type="hidden" name="candidatIds" id="candidatIds">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-primary">Transférer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Gestion de l'affichage des colonnes
        const STORAGE_KEY = 'candidatures_visible_columns';
        
        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            // Charger les préférences sauvegardées
            loadColumnPreferences();
            
            // Ajouter les écouteurs d'événements sur les checkboxes
            const checkboxes = document.querySelectorAll('.column-checkbox input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    toggleColumn(this.getAttribute('data-column'), this.checked);
                    saveColumnPreferences();
                });
            });
        });
        
        // Basculer l'affichage d'une colonne
        function toggleColumn(columnIndex, show) {
            const table = document.getElementById('candidaturesTable');
            if (!table) return;
            
            // Gérer les en-têtes
            const headers = table.querySelectorAll(`th[data-column="${columnIndex}"]`);
            headers.forEach(header => {
                header.style.display = show ? '' : 'none';
            });
            
            // Gérer les cellules
            const cells = table.querySelectorAll(`td[data-column="${columnIndex}"]`);
            cells.forEach(cell => {
                cell.style.display = show ? '' : 'none';
            });
        }
        
        // Sauvegarder les préférences dans le localStorage
        function saveColumnPreferences() {
            const checkboxes = document.querySelectorAll('.column-checkbox input[type="checkbox"]');
            const preferences = {};
            
            checkboxes.forEach(checkbox => {
                const columnIndex = checkbox.getAttribute('data-column');
                preferences[columnIndex] = checkbox.checked;
            });
            
            localStorage.setItem(STORAGE_KEY, JSON.stringify(preferences));
        }
        
        // Charger les préférences depuis le localStorage
        function loadColumnPreferences() {
            const savedPreferences = localStorage.getItem(STORAGE_KEY);
            
            if (savedPreferences) {
                const preferences = JSON.parse(savedPreferences);
                
                Object.keys(preferences).forEach(columnIndex => {
                    const checkbox = document.querySelector(`input[data-column="${columnIndex}"]`);
                    if (checkbox) {
                        checkbox.checked = preferences[columnIndex];
                        toggleColumn(columnIndex, preferences[columnIndex]);
                    }
                });
            }
        }
        
        // Sélectionner toutes les colonnes
        function selectAllColumns() {
            const checkboxes = document.querySelectorAll('.column-checkbox input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                toggleColumn(checkbox.getAttribute('data-column'), true);
            });
            saveColumnPreferences();
        }
        
        // Désélectionner toutes les colonnes
        function deselectAllColumns() {
            const checkboxes = document.querySelectorAll('.column-checkbox input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                toggleColumn(checkbox.getAttribute('data-column'), false);
            });
            saveColumnPreferences();
        }
        
        // Réinitialiser aux valeurs par défaut
        function resetColumns() {
            localStorage.removeItem(STORAGE_KEY);
            
            // Colonnes par défaut (cochées)
            const defaultColumns = ['0', '1', '2', '3', '4', '5', '7', '16', '24'];
            
            const checkboxes = document.querySelectorAll('.column-checkbox input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                const columnIndex = checkbox.getAttribute('data-column');
                const shouldCheck = defaultColumns.includes(columnIndex);
                checkbox.checked = shouldCheck;
                toggleColumn(columnIndex, shouldCheck);
            });
        }
        
        // ========== Gestion du transfert multiple ==========
        
        // Mettre à jour le compteur de sélection
        function updateSelectionCount() {
            const checkboxes = document.querySelectorAll('.candidat-checkbox:checked');
            const count = checkboxes.length;
            
            document.getElementById('countSelected').textContent = count;
            document.getElementById('btnTransfertMultiple').disabled = count === 0;
        }
        
        // Sélectionner/désélectionner tous
        function toggleSelectAll(checkbox) {
            const candidatCheckboxes = document.querySelectorAll('.candidat-checkbox');
            candidatCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateSelectionCount();
        }
        
        // Afficher la modale de transfert
        function showTransfertModal() {
            const checkboxes = document.querySelectorAll('.candidat-checkbox:checked');
            const selectedIds = [];
            let nbAutorises = 0;
            let nbNonAutorises = 0;
            
            checkboxes.forEach(cb => {
                selectedIds.push(cb.value);
                if (cb.getAttribute('data-autorise') === 'O') {
                    nbAutorises++;
                } else {
                    nbNonAutorises++;
                }
            });
            
            // Mettre à jour les informations dans la modale
            document.getElementById('nbCandidatsSelectionnes').textContent = selectedIds.length;
            document.getElementById('candidatIds').value = selectedIds.join(',');
            
            // Afficher l'alerte si certains candidats n'autorisent pas la diffusion
            const alertNonAutorises = document.getElementById('alertNonAutorises');
            if (nbNonAutorises > 0) {
                document.getElementById('nbNonAutorises').textContent = nbNonAutorises;
                alertNonAutorises.style.display = 'block';
            } else {
                alertNonAutorises.style.display = 'none';
            }
            
            // Afficher la modale
            const modal = new bootstrap.Modal(document.getElementById('transfertModal'));
            modal.show();
        }
    </script>
</body>
</html>